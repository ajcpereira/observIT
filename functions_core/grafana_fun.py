#
#
#
#


import json, requests, logging
from platform import system

from functions_core.yaml_validate import *
from functions_core.grafanafun_dm import *
from functions_core.grafanalib_ext import *
from grafanalib._gen import DashboardEncoder


def get_dashboard_json(dashboard, overwrite=False, message="Updated by grafanlib"):
    '''
    get_dashboard_json generates JSON from grafanalib Dashboard object

    :param dashboard - Dashboard() created via grafanalib
    '''

    # grafanalib generates json which need to pack to "dashboard" root element
    return json.dumps(
        {
            "dashboard": dashboard.to_json_data(),
            "overwrite": overwrite,
            "message": message
        }, sort_keys=True, indent=2, cls=DashboardEncoder)


def upload_to_grafana(json_data, server, api_key, verify=False):
    '''
    upload_to_grafana tries to upload dashboard to grafana and prints response

    :param json_data - dashboard json generated by grafanalib
    :param server - grafana server name
    :param api_key - grafana api key with read and write privileges
    '''

    headers = {'Authorization': f"Bearer {api_key}", 'Content-Type': 'application/json'}

    try:
        r = requests.post(f"https://{server}/api/dashboards/db", data=json_data, headers=headers, verify=verify)
        logging.debug("Message from grafana_fun is %s" % r.json())
    except Exception as msgerror:
        logging.error("Failed to create report in grafana %s with error %s" % (server, msgerror))
        return None

    return r


def create_system_dashboard(sys, config):
    panels = []
    templating = []
    y_pos = 3

    panels = panels + create_title_panel(str(sys['system']))

    for res in sys['resources']:
        match res['name']:
            case "linux_os":
                y_pos, res_panel = graph_linux_os(str(sys['system']), str(res['name']), res['data'], y_pos)
                panels = panels + res_panel
            case "eternus_cs8000":
                y_pos, res_panel = graph_eternus_cs8000(str(sys['system']), str(res['name']), res['data'], y_pos)
                templating = create_dashboard_vars(res['data'])
                panels = panels + res_panel
            case "powerstore":
                y_pos, res_panel = graph_powerstore(str(sys['system']), str(res['name']), res['data'], y_pos)
                panels = panels + res_panel
            case "eternus_dx":
                y_pos, res_panel = graph_eternus_dx(str(sys['system']), str(res['name']), res['data'], y_pos)
                templating = graph_eternus_dx_dashboard_vars(res['data'])
                panels = panels + res_panel

    my_dashboard = Dashboard(
        title="System " + sys['system'] + " dashboard",
        description="fjcollector auto generated dashboard",
        tags=[
            sys['system'],
        ],
        timezone="browser",
        refresh="1m",
        panels=panels,
        templating=Templating(templating),
    ).auto_panel_ids()

    return my_dashboard


########################################################################################################################
#
# function: build_dashboards
#
# This function builds a grafana dashboard based on the monitored items, configured on the config.yaml file.
########################################################################################################################

def build_dashboards(config):
    # Dashboards will be overwritten

    logging.debug("%s: Automagically build grafana dashboards", build_dashboards.__name__)
    grafana_api_key = config.global_parameters.grafana_api_key
    grafana_server = config.global_parameters.grafana_server + ":3000"

    # systems = build_grafana_fun_data_model(config)
    systems = data_model_build(config)

    for sys in systems:
        my_dashboard = create_system_dashboard(sys, config)
        my_dashboard_json = get_dashboard_json(my_dashboard, overwrite=True, message="Updated by fjcollector")
        logging.debug("Created dashboard %s", my_dashboard_json)
        upload_to_grafana(my_dashboard_json, grafana_server, grafana_api_key)

    hosts_per_res = data_model_get_hosts_per_resource_grouped(systems)
    my_dashboard = create_main_observit_dashboard(hosts_per_res)
    
    my_dashboard_json = get_dashboard_json(my_dashboard, overwrite=True, message="Updated by grafun-cli")
    res = upload_to_grafana(my_dashboard_json, grafana_server, grafana_api_key)

    if res is not None:
        if res.status_code == 200:
            logging.debug(f"Main observIT dashboard created ({res.status_code} {res.reason})")
            return -1
        else:
            logging.error(f"Unable to create Main observIT dashboard error is: {res.status_code} {res.reason}")
    else:
        logging.error(f"Unexpected error occurred!!!")
        return -1

    return 1


########################################################################################################################
#
# Resource Type: linux_os
#
########################################################################################################################


def graph_linux_os(system_name, resource_name, data, global_pos):
    # todo:

    panels_list = []
    y_pos = global_pos

    for metric in data:
        match metric['metric']:
            case "cpu":
                y_pos, panel = graph_linux_os_cpu(system_name, resource_name, metric, y_pos)
                panels_list = panels_list + panel

            case "mem":
                y_pos, panel = graph_linux_os_mem(system_name, resource_name, metric, y_pos)
                panels_list = panels_list + panel

            case "fs":
                y_pos, panel = graph_linux_os_fs(system_name, resource_name, metric, y_pos)
                panels_list = panels_list + panel

            case "net":
                y_pos, panel = graph_linux_os_net(system_name, resource_name, metric, y_pos)
                panels_list = panels_list + panel

    return y_pos, panels_list


########################################################################################################################
#
# Resource Type: eternus_cs8000
#
########################################################################################################################

def graph_eternus_cs8000(system_name, resource_name, data, global_pos):
    panels_list = []
    y_pos = global_pos

    for metric in data:
        match metric['metric']:
            case "fs_io":
                y_pos, panel = graph_eternus_cs8000_fs_io(system_name, resource_name, metric, y_pos)
                panels_list = panels_list + panel

            case "drives":
                y_pos, panel = graph_eternus_cs8000_drives(system_name, resource_name, y_pos)
                panels_list = panels_list + panel

            case "medias":
                y_pos, panel = graph_eternus_cs8000_medias(system_name, resource_name, y_pos)
                panels_list = panels_list + panel

            case "pvgprofile":
                y_pos, panel = graph_eternus_cs8000_pvgprofile(system_name, resource_name, y_pos)
                panels_list = panels_list + panel

            case "fc":
                y_pos, panel = graph_eternus_cs8000_fc(system_name, resource_name, metric, y_pos)
                panels_list = panels_list + panel

            case "cpu":
                y_pos, panel = graph_linux_os_cpu(system_name, resource_name, metric, y_pos)
                panels_list = panels_list + panel

            case "mem":
                y_pos, panel = graph_linux_os_mem(system_name, resource_name, metric, y_pos)
                panels_list = panels_list + panel

            case "fs":
                y_pos, panel = graph_linux_os_fs(system_name, resource_name, metric, y_pos)
                #y_pos, panel = graph_eternus_cs8000_fs(system_name, resource_name, metric, y_pos)
                panels_list = panels_list + panel

            case "net":
                y_pos, panel = graph_linux_os_net(system_name, resource_name, metric, y_pos)
                panels_list = panels_list + panel

    return y_pos, panels_list


########################################################################################################################
#
# Resource Type: create_title_panel
#
########################################################################################################################
def create_title_panel(system_name, panel_title=""):
    str_msg = "<br><p style=\"text-align:center\"><span style=\"font-size:36px\">System " + system_name + "</span></p>"

    panel = [Text(
        title=panel_title,
        gridPos=GridPos(h=3, w=24, x=0, y=0),
        mode="html",
        content=str_msg,
    )]

    return panel


def create_dashboard_vars(data):
    tpl_lst = []

    for metric in data:
        match metric['metric']:
            case "drives":
                tpl_lst = tpl_lst + [Template(
                    # dataSource="default",
                    name='tapename',
                    label='tapename',
                    query='SHOW TAG VALUES WITH KEY = \"tapename\"',
                    type='query',
                    includeAll=True,
                    multi=True,
                    allValue=True,
                    default='All',
                    refresh=2,
                    hide=HIDE_VARIABLE,
                )
                ]

    return tpl_lst


########################################################################################################################
#
# Resource Type: graph_linux_os_cpu
#   Plot
#
########################################################################################################################
def graph_linux_os_cpu(system_name, resource_name, metric, y_pos):
    str_title = f"CPU Usage ({resource_name})"
    panels_list = [RowPanel(title=str_title, gridPos=GridPos(h=1, w=24, x=0, y=y_pos))]
    line = y_pos + 1

    panels_target_list_cpu_use = []
    panels_target_list_cpu_load = []
    for host in metric['hosts']:
        panels_target_list_cpu_use.append(
            InfluxDBTarget(
                query=f"SELECT mean(\"use\") FROM \"cpu\" "
                      f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}') AND $timeFilter "
                      f"GROUP BY time($__interval), \"host\"::tag fill(null)",
                alias="$tag_host"
            )
        )

        panels_target_list_cpu_load.append(
            InfluxDBTarget(
                query=f"SELECT mean(\"load5m\") FROM \"cpu\" "
                      f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}') AND $timeFilter "
                      f"GROUP BY time($__interval), \"host\"::tag fill(null)",
                alias="$tag_host"
            )
        )

    # Create Panel to show CPU use Graph
    panels_list.append(CollectorTimeSeries(
        title="CPU utilization (%)",
        dataSource='default',
        targets=panels_target_list_cpu_use,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit="percent",
        gridPos=GridPos(h=7, w=12, x=0, y=line),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="right",
        legendDisplayMode="table",
        legendSortBy="Name",
        legendCalcs=['mean', 'max'],
        legendSortDesc=False,
        tooltipMode="multi",
        valueMax=100,
        )
    )

    # Create Panel do show CPU Load
    panels_list.append(CollectorTimeSeries(
        title="CPU Average Load (5 min)",
        dataSource='default',
        targets=panels_target_list_cpu_load,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit="",
        gridPos=GridPos(h=7, w=12, x=12, y=line),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="right",
        legendDisplayMode="table",
        legendSortBy="Name",
        legendCalcs=['mean', 'max'],
        tooltipMode="multi",
        legendSortDesc=False,
        )
    )

    line = line + 7

    return line, panels_list


def graph_linux_os_mem(system_name, resource_name, metric, y_pos):
    str_title = f"Memory Usage ({resource_name})"
    panels_list = [RowPanel(title=str_title, gridPos=GridPos(h=1, w=24, x=0, y=y_pos))]
    pos = y_pos + 1
    x_pos = 0

    query_template = (
        "SELECT last(\"{field}\") FROM \"mem\" "
        "WHERE (\"system\"::tag = '{system}' AND \"host\"::tag = '{host}') AND $timeFilter "
        "GROUP BY time($__interval) fill(none) "
    )

    sorted_hosts = sorted(metric['hosts'])

    for host in sorted_hosts:
        target_mem = [
            InfluxDBTarget(query=query_template.format(field="total", system=system_name, host=host), alias="Total"),
            InfluxDBTarget(query=query_template.format(field="used", system=system_name, host=host), alias="Used"),
        ]

        json_overrides = [

        ]

        panels_list.append(CollectorTimeSeries(
            title=f"{host} Memory Usage",
            dataSource='default',
            targets=target_mem,
            drawStyle='line',
            lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
            showPoints='auto',
            gradientMode=COLLECTOR_GRADIENT_MODE,
            fillOpacity=50,
            unit='decmbytes',
            gridPos=GridPos(h=7, w=4, x=x_pos, y=pos),
            spanNulls=COLLECTOR_SPAN_NULLS,
            legendPlacement="bottom",
            legendDisplayMode="table",
            legendSortBy="Name",
            legendCalcs=['last', 'mean', 'max'],
            valueDecimals=0,
            tooltipMode="multi",
            overrides=json_overrides,
        )
        )

        x_pos += 4
        if x_pos == 24:
            x_pos = 0
            pos += 7

    pos += 7

    return pos, panels_list


def graph_linux_os_net(system_name, resource_name, metric, y_pos):
    str_title = f"Network Usage ({resource_name})"
    panels_list = [RowPanel(title=str_title, gridPos=GridPos(h=1, w=24, x=0, y=y_pos))]
    pos = y_pos + 1

    for host in metric['hosts']:
        target_net = [
            InfluxDBTarget(
                query=f"SELECT non_negative_derivative(mean(\"tx_bytes\"), 1s)*8 FROM \"net\" "
                      f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}' AND \"if\"::tag!='lo') AND $timeFilter "
                      f"GROUP BY time($__interval), \"if\"::tag fill(null)",
                alias="$tag_if (Tx)"
            ),
            InfluxDBTarget(
                query=f"SELECT non_negative_derivative(mean(\"rx_bytes\"), 1s)*8 FROM \"net\" "
                      f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}' AND \"if\"::tag!='lo') AND $timeFilter "
                      f"GROUP BY time($__interval), \"if\"::tag fill(null)",
                alias="$tag_if (Rx)"
            )
        ]

        override_lst = [
            {
                "matcher": {
                    "id": "byFrameRefID",
                    "options": "B"
                },
                "properties": [
                    {
                        "id": "custom.transform",
                        "value": "negative-Y"
                    }
                ]
            }
        ]

        panels_list.append(CollectorTimeSeries(
            title=host + " Network Traffic",
            dataSource='default',
            targets=target_net,
            drawStyle='line',
            lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
            showPoints=COLLECTOR_SHOW_POINTS,
            gradientMode=COLLECTOR_GRADIENT_MODE,
            fillOpacity=COLLECTOR_FILL_OPACITY,
            unit=COLLECTOR_NET_UNITS,
            gridPos=GridPos(h=7, w=24, x=0, y=pos),
            spanNulls=COLLECTOR_SPAN_NULLS,
            legendPlacement="right",
            legendDisplayMode="table",
            stacking={"mode": "normal", "group": "A"},
            legendSortBy="Name",
            legendCalcs=['mean', 'max'],
            legendSortDesc=False,
            tooltipMode="multi",
            overrides=override_lst,
        ))

        pos = pos + 7

    return pos, panels_list


def graph_eternus_cs8000_fs_io(system_name, resource_name, metric, y_pos):
    str_title = "File System IO (" + resource_name + ")"
    panels_list = [RowPanel(title=str_title, gridPos=GridPos(h=1, w=24, x=0, y=y_pos)), ]
    pos = y_pos + 1
    panel_width = 5
    panel_height = 14

    for host in metric['hosts']:
        panels_target_list = [InfluxDBTarget(
            query=("SELECT mean(\"svctm\") FROM \"fs_io\" WHERE (\"system\"::tag = '" + system_name +
                   "' AND \"host\"::tag = '" + host +
                   "') AND $timeFilter GROUP BY time($__interval), \"fs\"::tag, \"dm\"::tag, \"rawdev\"::tag fill(null)"),
            alias="$tag_fs $tag_dm $tag_rawdev")]

        panels_list.append(CollectorTimeSeries(
            title=host + " Service Time",
            dataSource='default',
            targets=panels_target_list,
            drawStyle='line',
            lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
            showPoints=COLLECTOR_SHOW_POINTS,
            gradientMode=COLLECTOR_GRADIENT_MODE,
            fillOpacity=COLLECTOR_FILL_OPACITY,
            unit="ms",
            gridPos=GridPos(h=panel_height, w=panel_width, x=0, y=pos),
            spanNulls=COLLECTOR_SPAN_NULLS,
            legendPlacement="bottom",
            legendDisplayMode="table",
            legendCalcs=["max", "mean"],
            legendSortBy="Max",
            legendSortDesc=True,
        )
        )

        panels_target_list = [InfluxDBTarget(
            query=("SELECT mean(\"r/s\") FROM \"fs_io\" WHERE (\"system\"::tag = '" + system_name +
                   "' AND \"host\"::tag = '" + host +
                   "') AND $timeFilter GROUP BY time($__interval), \"fs\"::tag, \"dm\"::tag, \"rawdev\"::tag fill(null)"),
            alias="$tag_fs $tag_dm $tag_rawdev")]

        panels_list.append(CollectorTimeSeries(
            title=host + " Reads/s",
            dataSource='default',
            targets=panels_target_list,
            drawStyle='line',
            lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
            showPoints=COLLECTOR_SHOW_POINTS,
            gradientMode=COLLECTOR_GRADIENT_MODE,
            fillOpacity=COLLECTOR_FILL_OPACITY,
            unit="iops",
            gridPos=GridPos(h=panel_height, w=panel_width, x=1 * panel_width, y=pos),
            spanNulls=COLLECTOR_SPAN_NULLS,
            legendPlacement="bottom",
            legendDisplayMode="table",
            legendCalcs=["max", "mean"],
            legendSortBy="Max",
            legendSortDesc=True,
        )
        )

        panels_target_list = [InfluxDBTarget(
            query=("SELECT mean(\"r_await\") FROM \"fs_io\" WHERE (\"system\"::tag = '" + system_name +
                   "' AND \"host\"::tag = '" + host +
                   "') AND $timeFilter GROUP BY time($__interval), \"fs\"::tag, \"dm\"::tag, \"rawdev\"::tag fill(null)"),
            alias="$tag_fs $tag_dm $tag_rawdev")]

        panels_list.append(CollectorTimeSeries(
            title=host + " Read Average Wait Time",
            dataSource='default',
            targets=panels_target_list,
            drawStyle='line',
            lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
            showPoints=COLLECTOR_SHOW_POINTS,
            gradientMode=COLLECTOR_GRADIENT_MODE,
            fillOpacity=COLLECTOR_FILL_OPACITY,
            unit="ms",
            gridPos=GridPos(h=panel_height, w=panel_width, x=2 * panel_width, y=pos),
            spanNulls=COLLECTOR_SPAN_NULLS,
            legendPlacement="bottom",
            legendDisplayMode="table",
            legendCalcs=["max", "mean"],
            legendSortBy="Max",
            legendSortDesc=True,
        )
        )

        panels_target_list = [InfluxDBTarget(
            query=("SELECT mean(\"w/s\") FROM \"fs_io\" WHERE (\"system\"::tag = '" + system_name +
                   "' AND \"host\"::tag = '" + host +
                   "') AND $timeFilter GROUP BY time($__interval), \"fs\"::tag, \"dm\"::tag, \"rawdev\"::tag fill(null)"),
            alias="$tag_fs $tag_dm $tag_rawdev")]

        panels_list.append(CollectorTimeSeries(
            title=host + " Writes/s",
            dataSource='default',
            targets=panels_target_list,
            drawStyle='line',
            lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
            showPoints=COLLECTOR_SHOW_POINTS,
            gradientMode=COLLECTOR_GRADIENT_MODE,
            fillOpacity=COLLECTOR_FILL_OPACITY,
            unit="iops",
            gridPos=GridPos(h=panel_height, w=panel_width, x=3 * panel_width, y=pos),
            spanNulls=COLLECTOR_SPAN_NULLS,
            legendPlacement="bottom",
            legendDisplayMode="table",
            legendCalcs=["max", "mean"],
            legendSortBy="Max",
            legendSortDesc=True,
        )
        )

        panels_target_list = [InfluxDBTarget(
            query=("SELECT mean(\"w_await\") FROM \"fs_io\" WHERE (\"system\"::tag = '" + system_name +
                   "' AND \"host\"::tag = '" + host +
                   "') AND $timeFilter GROUP BY time($__interval), \"fs\"::tag, \"dm\"::tag, \"rawdev\"::tag fill(null)"),
            alias="$tag_fs $tag_dm $tag_rawdev")]

        panels_list.append(CollectorTimeSeries(
            title=host + " Write Average Wait Time",
            dataSource='default',
            targets=panels_target_list,
            drawStyle='line',
            lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
            showPoints=COLLECTOR_SHOW_POINTS,
            gradientMode=COLLECTOR_GRADIENT_MODE,
            fillOpacity=COLLECTOR_FILL_OPACITY,
            unit="ms",
            gridPos=GridPos(h=panel_height, w=panel_width - 1, x=4 * panel_width, y=pos),
            spanNulls=COLLECTOR_SPAN_NULLS,
            legendPlacement="bottom",
            legendDisplayMode="table",
            legendCalcs=["max", "mean"],
            legendSortBy="Max",
            legendSortDesc=True,
        )
        )

        pos = pos + 7

    return pos, panels_list


def graph_eternus_cs8000_drives(system_name, resource_name, y_pos):
    str_title = "Tape Libraries (" + resource_name + ")"
    panels_list = [RowPanel(title=str_title, gridPos=GridPos(h=1, w=24, x=0, y=y_pos))]
    line = y_pos + 1

    target_list = [
        InfluxDBTarget(
            query=f"SELECT last(\"total\") as Total FROM \"drives\" "
                  f"WHERE (\"system\"::tag = '{system_name}' AND \"tapename\"::tag =~ /^$tapename$/) AND $timeFilter "
                  f"GROUP BY time($__interval) fill(null)",
            alias=f"Total",
        ),
        InfluxDBTarget(
            query=f"SELECT last(\"used\")+last(\"other\") as Used FROM \"drives\" "
                  f"WHERE (\"system\"::tag = '{system_name}' AND \"tapename\"::tag =~ /^$tapename$/) AND $timeFilter "
                  f"GROUP BY time($__interval) fill(null)",
            alias="Used"
        ),
        InfluxDBTarget(
            query=f"SELECT last(\"other\") as Unavailable FROM \"drives\" "
                  f"WHERE (\"system\"::tag = '{system_name}' AND \"tapename\"::tag =~ /^$tapename$/) AND $timeFilter "
                  f"GROUP BY time($__interval) fill(null)",
            alias="Unavailable"
        ),
    ]

    override_lst = [
        {
            "matcher": {
                "id": "byName",
                "options": "Unavailable"
            },
            "properties": [
                {
                    "id": "custom.fillOpacity",
                    "value": 100
                },
                {
                    "id": "custom.gradientMode",
                    "value": "none"
                },
                {
                    "id": "color",
                    "value": {
                        "fixedColor": "#ff331c",
                        "mode": "fixed"
                    }
                }
            ]
        },
        {
            "matcher": {
                "id": "byName",
                "options": "Total"
            },
            "properties": [
                {
                    "id": "color",
                    "value": {
                        "fixedColor": "blue",
                        "mode": "fixed"
                    }
                }
            ]
        },
        {
            "matcher": {
                "id": "byName",
                "options": "Used"
            },
            "properties": [
                {
                    "id": "color",
                    "value": {
                        "fixedColor": "green",
                        "mode": "fixed"
                    }
                }
            ]
        }
    ]

    panels_list.append(CollectorTimeSeries(
        title="Tape Library $tapename",
        repeat=Repeat(direction='h', variable='tapename', maxPerRow=6),
        dataSource='default',
        targets=target_list,
        drawStyle='line',
        lineInterpolation='stepAfter',
        showPoints='auto',
        gradientMode='none',
        fillOpacity=50,
        unit='',
        gridPos=GridPos(h=7, w=12, x=0, y=line),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement='right',
        legendDisplayMode='table',
        valueDecimals=0,
        tooltipMode="multi",
        overrides=override_lst,
    )
    )

    line = line + 7

    return line, panels_list


def graph_eternus_cs8000_medias(system_name, resource_name, y_pos):
    str_title = "Tape Medias (" + resource_name + ")"
    panels_list = [RowPanel(title=str_title, gridPos=GridPos(h=1, w=24, x=0, y=y_pos))]
    line = y_pos + 1

    target_list = [InfluxDBTarget(
        query="SELECT  \"Total Cap GiB\" as \"Total Capacity\", \"Total Clean Medias\", \"Total Fault\","
              " \"Total Ina\" as \"Total Inactive\", \"Total Medias\", \"Total Val GiB\" as \"Total Valid\", "
              "\"Val %\" as \"Valid %\"  FROM \"medias\" WHERE $timeFilter AND (\"system\"::tag='" + system_name +
              "') GROUP BY \"host\"::tag, \"tapename\"::tag ORDER BY DESC LIMIT 1",
        format="table")]

    override_lst = [
        {
            "matcher": {
                "id": "byName",
                "options": "Time"
            },
            "properties": [
                {
                    "id": "custom.hidden",
                    "value": True
                }
            ]
        },
        {
            "matcher": {
                "id": "byName",
                "options": "Total Capacity"
            },
            "properties": [
                {
                    "id": "unit",
                    "value": "decgbytes"
                }
            ]
        },
        {
            "matcher": {
                "id": "byName",
                "options": "Total Valid"
            },
            "properties": [
                {
                    "id": "unit",
                    "value": "decgbytes"
                }
            ]
        },
        {
            "matcher": {
                "id": "byName",
                "options": "Valid %"
            },
            "properties": [
                {
                    "id": "unit",
                    "value": "percent"
                },
                {
                    "id": "thresholds",
                    "value": {
                        "mode": "absolute",
                        "steps": [
                            {
                                "color": "green",
                                "value": None
                            },
                            {
                                "color": "#EAB839",
                                "value": 65
                            },
                            {
                                "color": "red",
                                "value": 75
                            }
                        ]
                    }
                }
            ]
        }
    ]

    thres = [
        {
            "color": "text",
            "value": None
        }
    ]

    panels_list.append(CollectorTable(
        title="Tape Medias",
        dataSource='default',
        targets=target_list,
        gridPos=GridPos(h=7, w=24, x=0, y=line),
        filterable=True,
        displayMode="color-text",
        colorMode="thresholds",
        overrides=override_lst,
        thresholds=thres,
    )
    )

    line = line + 7

    return line, panels_list


def graph_eternus_cs8000_pvgprofile(system_name, resource_name, y_pos):
    str_title = "Physical Volume Group Profile (" + resource_name + ")"
    panels_list = [RowPanel(title=str_title, gridPos=GridPos(h=1, w=24, x=0, y=y_pos))]
    line = y_pos + 1

    target_list = [InfluxDBTarget(
        query="SELECT \"Total Medias\", \"Fault\", \"Ina\", \"Scr\", \"-10\", \"-20\", \"-30\", \"-40\", \"-50\", \"-60\", \"-70\", \"-80\", \"-90\", \">90\", \"Total Cap (GiB)\", \"Total Used (GiB)\" from pvgprofile WHERE $timeFilter AND (\"system\"::tag='" + system_name + "') GROUP BY \"pvgname\"::tag, \"host\"::tag ORDER BY DESC LIMIT 1",
        format="table")]

    override_lst = [
        {
            "matcher": {
                "id": "byName",
                "options": "Time"
            },
            "properties": [
                {
                    "id": "custom.hidden",
                    "value": True
                }
            ]
        },
        {
            "matcher": {
                "id": "byName",
                "options": "Scr"
            },
            "properties": [
                {
                    "id": "thresholds",
                    "value": {
                        "mode": "absolute",
                        "steps": [
                            {
                                "color": "green",
                                "value": None
                            },
                            {
                                "color": "red",
                                "value": 0
                            },
                            {
                                "color": "#EAB839",
                                "value": 10
                            },
                            {
                                "color": "green",
                                "value": 15
                            }
                        ]
                    }
                }
            ]
        },
        {
            "matcher": {
                "id": "byName",
                "options": "Total Cap (GiB)"
            },
            "properties": [
                {
                    "id": "unit",
                    "value": "decgbytes"
                }
            ]
        },
        {
            "matcher": {
                "id": "byName",
                "options": "Total Used (GiB)"
            },
            "properties": [
                {
                    "id": "unit",
                    "value": "decgbytes"
                }
            ]
        }
    ]

    thres = [
        {
            "color": "text",
            "value": None
        }
    ]

    panels_list.append(CollectorTable(
        title="Physical Volume Group",
        dataSource='default',
        targets=target_list,
        gridPos=GridPos(h=7, w=24, x=0, y=line),
        filterable=True,
        displayMode="color-text",
        colorMode="thresholds",
        overrides=override_lst,
        # thresholds=Threshold(line=False,color='text', index=0, value=0.0, op=EVAL_GT),
        thresholds=thres,
        fontSize="85%",
        minWidth=55,
        align="center",
    ))

    line = line + 7

    return line, panels_list


def graph_eternus_cs8000_fc(system_name, resource_name, metric, y_pos):
    str_title = f"FibreChannel Usage ({resource_name})"
    panels_list = [RowPanel(title=str_title, gridPos=GridPos(h=1, w=24, x=0, y=y_pos))]
    pos = y_pos + 1

    for host in metric['hosts']:
        target_net = [
            InfluxDBTarget(
                query=f"SELECT non_negative_derivative(mean(\"tx_bytes\"), 1s)*8 FROM \"fc\" "
                      f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}') AND $timeFilter "
                      f"GROUP BY time($__interval), \"hba\"::tag fill(null)",
                alias=f"$tag_hba (Tx)"),
            InfluxDBTarget(
                query=f"SELECT non_negative_derivative(mean(\"rx_bytes\"), 1s)*8 FROM \"fc\" "
                      f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}') AND $timeFilter "
                      f"GROUP BY time($__interval), \"hba\"::tag fill(null)",
                alias=f"$tag_hba (Rx)")
        ]

        override_lst = [
            {
                "matcher": {
                    "id": "byFrameRefID",
                    "options": "B"
                },
                "properties": [
                    {
                        "id": "custom.transform",
                        "value": "negative-Y"
                    }
                ]
            }
        ]

        panels_list.append(CollectorTimeSeries(
            title=host + " FC Traffic",
            dataSource='default',
            targets=target_net,
            drawStyle='line',
            lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
            showPoints=COLLECTOR_SHOW_POINTS,
            gradientMode=COLLECTOR_GRADIENT_MODE,
            fillOpacity=COLLECTOR_FILL_OPACITY,
            unit=COLLECTOR_FC_UNITS,
            gridPos=GridPos(h=7, w=24, x=0, y=pos),
            spanNulls=COLLECTOR_SPAN_NULLS,
            legendPlacement="right",
            legendDisplayMode="table",
            stacking={"mode": "normal", "group": "A"},
            legendSortBy="Name",
            legendCalcs=['mean', 'max'],
            legendSortDesc=False,
            overrides=override_lst,
        ))

        pos = pos + 7

    return pos, panels_list


def graph_linux_os_fs(system_name, resource_name, metric, y_pos):

    str_title = f"File System Capacity ({resource_name})"
    panels_list = [RowPanel(title=str_title, gridPos=GridPos(h=1, w=24, x=0, y=y_pos))]
    pos = y_pos + 1

    for host in metric['hosts']:
        target_fs = [
            InfluxDBTarget(
                query=f"SELECT SUM(\"Total\") FROM (SELECT LAST(\"total\") AS \"Total\" FROM \"fs\" "
                      f"WHERE (\"system\" = '{system_name}' AND \"host\" = '{host}') "
                      f"GROUP BY time($__interval), \"mount\", \"host\", \"system\" fill(null)) WHERE $timeFilter GROUP BY time($__interval)",
                alias="Total"
            ),
            InfluxDBTarget(
                query=f"SELECT SUM(\"Used\") FROM (SELECT LAST(\"used\") AS \"Used\" FROM \"fs\" "
                      f"WHERE (\"system\" = '{system_name}' AND \"host\" = '{host}') "
                      f"GROUP BY time($__interval), \"mount\", \"host\", \"system\" fill(null)) WHERE $timeFilter GROUP BY time($__interval)",
                alias="Used"
            ),
            InfluxDBTarget(
                query=f"SELECT HOLT_WINTERS(SUM(\"Used\"), 30, 0) FROM (SELECT LAST(\"used\") as \"Used\" FROM \"fs\" "
                      f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}') "
                      f"GROUP BY time($__interval), \"mount\"::tag, \"host\"::tag, \"system\"::tag fill(null)) "
                      f"WHERE $timeFilter "
                      f"GROUP BY time($__interval)",
                alias="Forecast"
            )
        ]

        target_fs_table = [
            InfluxDBTarget(
                query=f"SELECT \"used\"/\"total\"*100 as \"%Used\", \"total\" as \"Total\", \"used\" as \"Used\", \"total\"-\"used\" as \"Available\" FROM \"fs\" "
                      f"WHERE $timeFilter AND ( \"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}') "
                      f"GROUP BY \"mount\"::tag ORDER BY time DESC LIMIT 1",
                format="table"
            )
        ]

        json_overrides = [
            {
                "matcher": {
                    "id": "byName",
                    "options": "Total"
                },
                "properties": [
                    {
                        "id": "custom.fillBelowTo",
                        "value": "Used"
                    },
                    {
                        "id": "color",
                        "value": {
                            "fixedColor": "super-light-blue",
                            "mode": "fixed"
                        }
                    },
                    {
                        "id": "custom.lineWidth",
                        "value": 2
                    }
                ]
            },
            {
                "matcher": {
                    "id": "byName",
                    "options": "Growth"
                },
                "properties": [
                    {
                        "id": "color",
                        "value": {
                            "fixedColor": "orange",
                            "mode": "fixed"
                        }
                    },
                    {
                        "id": "custom.lineWidth",
                        "value": 4
                    },
                    {
                        "id": "custom.axisPlacement",
                        "value": "right"
                    },
                    {
                        "id": "custom.fillOpacity",
                        "value": 0
                    },
                    {
                        "id": "custom.lineInterpolation",
                        "value": "stepAfter"
                    }
                ]
            },
            {
                "matcher": {
                    "id": "byName",
                    "options": "Forecast"
                },
                "properties": [
                    {
                        "id": "color",
                        "value": {
                            "fixedColor": "super-light-purple",
                            "mode": "fixed"
                        }
                    }
                ]
            },
            {
                "matcher": {
                    "id": "byName",
                    "options": "Used"
                },
                "properties": [
                    {
                        "id": "color",
                        "value": {
                            "mode": "fixed",
                            "fixedColor": "blue"
                        }
                    }
                ]
            }
        ]


        panels_list.append(CollectorTimeSeries(
            title=f"{host} Filesystem Usage (Last value interval $__interval)",
            dataSource='default',
            targets=target_fs,
            drawStyle='line',
            lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
            showPoints=COLLECTOR_SHOW_POINTS,
            gradientMode=COLLECTOR_GRADIENT_MODE,
            fillOpacity=COLLECTOR_FILL_OPACITY,
            unit=COLLECTOR_FS_UNITS,
            gridPos=GridPos(h=10, w=24, x=0, y=pos),
            spanNulls=COLLECTOR_SPAN_NULLS,
            legendPlacement="bottom",
            legendDisplayMode="table",
            legendCalcs=['mean', 'min', 'max'],
            tooltipMode="multi",
            overrides=json_overrides,
        ))


        json_overrides_table = [
            {
                "matcher": {
                    "id": "byName",
                    "options": "%Used"
                },
                "properties": [
                    {
                        "id": "unit",
                        "value": "percent"
                    },
                    {
                        "id": "custom.cellOptions",
                        "value": {
                            "mode": "basic",
                            "type": "gauge",
                            "valueDisplayMode": "color"
                        }
                    },
                    {
                        "id": "max",
                        "value": 100
                    },
                    {
                        "id": "min",
                        "value": 0
                    },
                    {
                        "id": "thresholds",
                        "value": {
                            "mode": "percentage",
                            "steps": [
                                {
                                    "color": "green",
                                    "value": None
                                },
                                {
                                    "color": "red",
                                    "value": 95
                                }
                            ]
                        }
                    }
                ]
            },
            {
                "matcher": {
                    "id": "byName",
                    "options": "Time"
                },
                "properties": [
                    {
                        "id": "custom.hidden",
                        "value": True
                    }
                ]
            }
        ]

        table_field_sort = [TableSortByField(displayName='%Used', desc=True)]

        panels_list.append(CollectorTable(
            title=host + " File System Capacity Table",
            dataSource='default',
            targets=target_fs_table,
            gridPos=GridPos(h=10, w=24, x=0, y=pos + 10),
            filterable=True,
            unit=COLLECTOR_FS_UNITS,
            displayMode="color-text",
            colorMode="thresholds",
            overrides=json_overrides_table,
            sortBy=table_field_sort,
            )
        )

        pos = pos + 20

    return pos, panels_list


########################################################################################################################
#
# Resource Type: powerstore
#
########################################################################################################################


def graph_powerstore(system_name, resource_name, data, global_pos):

    panels_list = []
    y_pos = global_pos

    for metric in data:
        match metric['metric']:
            case "node":
                y_pos, panel = graph_powerstore_node_cpu(system_name, resource_name, metric, y_pos)
                panels_list = panels_list + panel
                y_pos, panel = graph_powerstore_node_read(system_name, resource_name, metric, y_pos)
                panels_list = panels_list + panel
                y_pos, panel = graph_powerstore_node_write(system_name, resource_name, metric, y_pos)
                panels_list = panels_list + panel
                y_pos, panel = graph_powerstore_node_total(system_name, resource_name, metric, y_pos)
                panels_list = panels_list + panel
            case "space":
                y_pos, panel = graph_powerstore_space(system_name, resource_name, metric, y_pos)
                panels_list = panels_list + panel

    return y_pos, panels_list


########################################################################################################################
#
# Resource Type: graph_powerstore_node_cpu
#   Plot
#
########################################################################################################################
def graph_powerstore_node_cpu(system_name, resource_name, metric, y_pos):
    str_title = f"CPU Usage ({resource_name})"
    panels_list = [RowPanel(title=str_title, gridPos=GridPos(h=1, w=24, x=0, y=y_pos))]
    line = y_pos + 1

    panels_target_list_cpu_use = []

    for host in metric['hosts']:
        panels_target_list_cpu_use.append(
            InfluxDBTarget(
                query=f"SELECT 100 * mean(\"io_workload_cpu_utilization\") FROM \"powerstore_node\" "
                      f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}') AND $timeFilter "
                      f"GROUP BY time($__interval), \"host\"::tag, \"node_id\"::tag fill(null)",      
                alias="$tag_host $tag_node_id"
            )
        )

    # Create Panel to show CPU use Graph
    panels_list.append(CollectorTimeSeries(
        title="CPU utilization (%)",
        dataSource='default',
        targets=panels_target_list_cpu_use,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit="percent",
        gridPos=GridPos(h=7, w=24, x=0, y=line),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="right",
        legendDisplayMode="table",
        legendSortBy="Name",
        legendCalcs=['mean', 'max'],
        legendSortDesc=False,
        tooltipMode="multi",
        valueMax=100,
        )
    )

    line = line + 7

    return line, panels_list


def graph_powerstore_node_read(system_name, resource_name, metric, y_pos):
    str_title = f"Read Performance ({resource_name})"
    panels_list = [RowPanel(title=str_title, gridPos=GridPos(h=1, w=24, x=0, y=y_pos))]
    line = y_pos + 1

    # Create Panel to show Read Latency
    panels_target_list = []
    for host in metric['hosts']:
        panels_target_list.append(
            InfluxDBTarget(
                query=f"SELECT mean(\"avg_read_latency\") FROM \"powerstore_node\" "
                      f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}') AND $timeFilter "
                      f"GROUP BY time($__interval), \"host\"::tag, \"node_id\"::tag fill(null)",
                alias="$tag_host $tag_node_id"
            )
        )

    panels_list.append(CollectorTimeSeries(
        title="Read Latency Avg",
        dataSource='default',
        targets=panels_target_list,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit="µs",
        gridPos=GridPos(h=7, w=8, x=0, y=line),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="bottom",
        legendDisplayMode="table",
        legendSortBy="Name",
        legendCalcs=['mean', 'max'],
        tooltipMode="multi",
        legendSortDesc=False,
    )
    )

    # Create Panel to show Read IO
    panels_target_list = []
    for host in metric['hosts']:
        panels_target_list.append(
            InfluxDBTarget(
                query=f"SELECT mean(\"read_iops\") FROM \"powerstore_node\" "
                      f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}') AND $timeFilter "
                      f"GROUP BY time($__interval), \"host\"::tag, \"node_id\"::tag fill(null)",
                alias="$tag_host $tag_node_id"
            )
        )

    panels_list.append(CollectorTimeSeries(
        title="Read IOPS",
        dataSource='default',
        targets=panels_target_list,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit="iops",
        gridPos=GridPos(h=7, w=8, x=8, y=line),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="bottom",
        legendDisplayMode="table",
        legendSortBy="Name",
        legendCalcs=['mean', 'max'],
        tooltipMode="multi",
        legendSortDesc=False,
    )
    )

    # Create Panel to show Read Bandwidth
    panels_target_list = []
    for host in metric['hosts']:
        panels_target_list.append(
            InfluxDBTarget(
                query=f"SELECT mean(\"read_bandwidth\") FROM \"powerstore_node\" "
                      f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}') AND $timeFilter "
                      f"GROUP BY time($__interval), \"host\"::tag, \"node_id\"::tag fill(null)",
                alias="$tag_host $tag_node_id"
            )
        )

    panels_list.append(CollectorTimeSeries(
        title="Read Bandwidth",
        dataSource='default',
        targets=panels_target_list,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit="binBps",
        gridPos=GridPos(h=7, w=8, x=16, y=line),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="bottom",
        legendDisplayMode="table",
        legendSortBy="Name",
        legendCalcs=['mean', 'max'],
        tooltipMode="multi",
        legendSortDesc=False,
    )
    )

    line = line + 7

    return line, panels_list


def graph_powerstore_node_write(system_name, resource_name, metric, y_pos):
    str_title = f"Write Performance ({resource_name})"
    panels_list = [RowPanel(title=str_title, gridPos=GridPos(h=1, w=24, x=0, y=y_pos))]
    line = y_pos + 1

    # Create Panel to show Write Latency
    panels_target_list = []
    for host in metric['hosts']:
        panels_target_list.append(
            InfluxDBTarget(
                query=f"SELECT mean(\"avg_write_latency\") FROM \"powerstore_node\" "
                      f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}') AND $timeFilter "
                      f"GROUP BY time($__interval), \"host\"::tag, \"node_id\"::tag fill(null)",
                alias="$tag_host $tag_node_id"
            )
        )

    panels_list.append(CollectorTimeSeries(
        title="Write Latency Avg",
        dataSource='default',
        targets=panels_target_list,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit="µs",
        gridPos=GridPos(h=7, w=8, x=0, y=line),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="bottom",
        legendDisplayMode="table",
        legendSortBy="Name",
        legendCalcs=['mean', 'max'],
        tooltipMode="multi",
        legendSortDesc=False,
    )
    )

    # Create Panel to show Write IO
    panels_target_list = []
    for host in metric['hosts']:
        panels_target_list.append(
            InfluxDBTarget(
                query=f"SELECT mean(\"write_iops\") FROM \"powerstore_node\" "
                      f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}') AND $timeFilter "
                      f"GROUP BY time($__interval), \"host\"::tag, \"node_id\"::tag fill(null)",
                alias="$tag_host $tag_node_id"
            )
        )

    panels_list.append(CollectorTimeSeries(
        title="Write IOPS",
        dataSource='default',
        targets=panels_target_list,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit="iops",
        gridPos=GridPos(h=7, w=8, x=8, y=line),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="bottom",
        legendDisplayMode="table",
        legendSortBy="Name",
        legendCalcs=['mean', 'max'],
        tooltipMode="multi",
        legendSortDesc=False,
    )
    )

    # Create Panel to show Write Bandwidth
    panels_target_list = []
    for host in metric['hosts']:
        panels_target_list.append(
            InfluxDBTarget(
                query=f"SELECT mean(\"write_bandwidth\") FROM \"powerstore_node\" "
                      f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}') AND $timeFilter "
                      f"GROUP BY time($__interval), \"host\"::tag, \"node_id\"::tag fill(null)",
                alias="$tag_host $tag_node_id"
            )
        )

    panels_list.append(CollectorTimeSeries(
        title="Write Bandwidth",
        dataSource='default',
        targets=panels_target_list,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit="binBps",
        gridPos=GridPos(h=7, w=8, x=16, y=line),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="bottom",
        legendDisplayMode="table",
        legendSortBy="Name",
        legendCalcs=['mean', 'max'],
        tooltipMode="multi",
        legendSortDesc=False,
    )
    )

    line = line + 7

    return line, panels_list



def graph_powerstore_node_total(system_name, resource_name, metric, y_pos):
    str_title = f"Total Performance ({resource_name})"
    panels_list = [RowPanel(title=str_title, gridPos=GridPos(h=1, w=24, x=0, y=y_pos))]
    line = y_pos + 1

    # Create Panel to show Write Latency
    panels_target_list = []
    for host in metric['hosts']:
        panels_target_list.append(
            InfluxDBTarget(
                query=f"SELECT mean(\"avg_latency\") FROM \"powerstore_node\" "
                      f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}') AND $timeFilter "
                      f"GROUP BY time($__interval), \"host\"::tag, \"node_id\"::tag fill(null)",
                alias="$tag_host $tag_node_id"
            )
        )

    panels_list.append(CollectorTimeSeries(
        title="Total Latency Avg",
        dataSource='default',
        targets=panels_target_list,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit="µs",
        gridPos=GridPos(h=7, w=8, x=0, y=line),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="bottom",
        legendDisplayMode="table",
        legendSortBy="Name",
        legendCalcs=['mean', 'max'],
        tooltipMode="multi",
        legendSortDesc=False,
    )
    )

    # Create Panel to show Total IOPS
    panels_target_list = []
    for host in metric['hosts']:
        panels_target_list.append(
            InfluxDBTarget(
                query=f"SELECT mean(\"total_iops\") FROM \"powerstore_node\" "
                      f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}') AND $timeFilter "
                      f"GROUP BY time($__interval), \"host\"::tag, \"node_id\"::tag fill(null)",
                alias="$tag_host $tag_node_id"
            )
        )

    panels_list.append(CollectorTimeSeries(
        title="Total IOPS",
        dataSource='default',
        targets=panels_target_list,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit="iops",
        gridPos=GridPos(h=7, w=8, x=8, y=line),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="bottom",
        legendDisplayMode="table",
        legendSortBy="Name",
        legendCalcs=['mean', 'max'],
        tooltipMode="multi",
        legendSortDesc=False,
    )
    )

    # Create Panel to show Total Bandwidth
    panels_target_list = []
    for host in metric['hosts']:
        panels_target_list.append(
            InfluxDBTarget(
                query=f"SELECT mean(\"total_bandwidth\") FROM \"powerstore_node\" "
                      f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}') AND $timeFilter "
                      f"GROUP BY time($__interval), \"host\"::tag, \"node_id\"::tag fill(null)",
                alias="$tag_host $tag_node_id"
            )
        )

    panels_list.append(CollectorTimeSeries(
        title="Total Bandwidth",
        dataSource='default',
        targets=panels_target_list,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit="binBps",
        gridPos=GridPos(h=7, w=8, x=16, y=line),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="bottom",
        legendDisplayMode="table",
        legendSortBy="Name",
        legendCalcs=['mean', 'max'],
        tooltipMode="multi",
        legendSortDesc=False,
    )
    )

    line = line + 7

    return line, panels_list



def graph_powerstore_space(system_name, resource_name, metric, y_pos):

    # marteladão - tem de ser melhorado (está a forçar este painel a seguir ao cpu)
    y_pos = 4
    str_title = f"Capacity ({resource_name})"
    panels_list = [RowPanel(title=str_title, gridPos=GridPos(h=1, w=24, x=0, y=y_pos))]
    line = y_pos + 1

    #panels_target_list = []
    panels_target_physical_list = []
    panels_target_reduction_list = []
    panels_target_logical_list = []
    for host in metric['hosts']:
        #Target queries for Physical Space
        panels_target_physical_list.append(
                InfluxDBTarget(
                query=f"SELECT max(\"physical_total\") FROM \"powerstore_space\" "
                      f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}') AND $timeFilter "
                      f"GROUP BY time($__interval), \"host\"::tag, \"appliance_id\"::tag fill(null)",
                alias="$tag_host $tag_appliance_id Physical Total",
            ),
        )
        panels_target_physical_list.append(
            InfluxDBTarget(
                query=f"SELECT max(\"physical_used\") FROM \"powerstore_space\" "
                      f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}') AND $timeFilter "
                      f"GROUP BY time($__interval), \"host\"::tag, \"appliance_id\"::tag fill(null)",
                alias="$tag_host $tag_appliance_id Physical Used",
            ),
        )
        # Target queries for Data Reduction
        panels_target_reduction_list.append(
                InfluxDBTarget(
                query="SELECT max(\"data_reduction\") FROM \"powerstore_space\" "
                      f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}') AND $timeFilter "
                      "GROUP BY time($__interval), \"host\"::tag, \"appliance_id\"::tag fill(null)",
                alias="$tag_host $tag_appliance_id Data Reduction",
            ),
        )
        #Target queries for Logical Space
        panels_target_logical_list.append(
                InfluxDBTarget(
                query=f"SELECT max(\"logical_provisioned\") FROM \"powerstore_space\" "
                      f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}') AND $timeFilter "
                      f"GROUP BY time($__interval), \"host\"::tag, \"appliance_id\"::tag fill(null)",
                alias="$tag_host $tag_appliance_id Logical Provisioned",
            ),
        )
        panels_target_logical_list.append(
            InfluxDBTarget(
                query=f"SELECT max(\"logical_used\") FROM \"powerstore_space\" "
                      f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}') AND $timeFilter "
                      f"GROUP BY time($__interval), \"host\"::tag, \"appliance_id\"::tag fill(null)",
                alias="$tag_host $tag_appliance_id Logical Used",
            ),
        )

        # Panel for Logical Space
    panels_list.append(CollectorTimeSeries(
        title="Space Usage Logical",
        dataSource='default',
        targets=panels_target_logical_list,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit="bytes",
        gridPos=GridPos(h=7, w=8, x=0, y=line),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="bottom",
        legendDisplayMode="table",
        legendSortBy="Name",
        legendCalcs=['mean', 'max'],
        tooltipMode="multi",
        legendSortDesc=False,
    )
    )

    # Panel for Data Reduction
    panels_list.append(CollectorTimeSeries(
        title="Space Data Reduction",
        dataSource='default',
        targets=panels_target_reduction_list,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit="none",
        valueMax=12,
        valueDecimals=2,
        gridPos=GridPos(h=7, w=8, x=8, y=line),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="bottom",
        legendDisplayMode="table",
        legendSortBy="Name",
        legendCalcs=['mean', 'max'],
        tooltipMode="multi",
        legendSortDesc=False,
    )
    )

    #Panel for Physical Space
    panels_list.append(CollectorTimeSeries(
        title="Space Usage Physical",
        dataSource='default',
        targets=panels_target_physical_list,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit="bytes",
        gridPos=GridPos(h=7, w=8, x=16, y=line),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="bottom",
        legendDisplayMode="table",
        legendSortBy="Name",
        legendCalcs=['mean', 'max'],
        tooltipMode="multi",
        legendSortDesc=False,
    )
    )

    line = line + 7

    return line, panels_list


########################################################################################################################
#
# Resource Type: graph_eternus_dx_cpu
#   Plot
#
########################################################################################################################
def graph_eternus_dx_cpu(system_name, resource_name, metric, y_pos):
    str_title = f"CPU Usage ({resource_name})"
    panels_list = [RowPanel(title=str_title, gridPos=GridPos(h=1, w=24, x=0, y=y_pos))]
    line = y_pos + 1

    panels_target_list_cpu_use = []

    for host in metric['hosts']:
        panels_target_list_cpu_use.append(
            InfluxDBTarget(
                query=f"SELECT mean(\"busyrate\") FROM \"eternus_dx_cpu\" " 
                      f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}') AND $timeFilter "
                      f"GROUP BY time($__interval), \"host\"::tag, \"CM\"::tag, \"Core\"::tag fill(null)",
                alias="$tag_host CM#$tag_CM Core#$tag_Core"
            )
        )

    # Create Panel to show CPU use Graph
    panels_list.append(CollectorTimeSeries(
        title="CPU utilization (%)",
        dataSource='default',
        targets=panels_target_list_cpu_use,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit="percent",
        gridPos=GridPos(h=7, w=24, x=0, y=line),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="right",
        legendDisplayMode="table",
        legendSortBy="Name",
        legendCalcs=['mean', 'max'],
        legendSortDesc=False,
        tooltipMode="multi",
        valueMax=100,
        )
    )

    line = line + 7

    return line, panels_list



########################################################################################################################
#
# Resource Type: eternus_dx
#
########################################################################################################################


def graph_eternus_dx(system_name, resource_name, data, global_pos):

    panels_list = []
    y_pos = global_pos

    for metric in data:
        match metric['metric']:
            case "cpu":
                y_pos, panel = graph_eternus_dx_cpu(system_name, resource_name, metric, y_pos)
                panels_list = panels_list + panel
            case "tppool":
                y_pos, panel = graph_eternus_dx_tpp(system_name, resource_name, metric, y_pos)
                panels_list = panels_list + panel
            case "vol":
                 y_pos, panel = graph_eternus_dx_vol_read(system_name, resource_name, metric, y_pos)
                 panels_list = panels_list + panel
                 y_pos, panel = graph_eternus_dx_vol_write(system_name, resource_name, metric, y_pos)
                 panels_list = panels_list + panel
            case "power":
                 y_pos, panel = graph_eternus_dx_power(system_name, resource_name, metric, y_pos)
                 panels_list = panels_list + panel
            case "temp":
                 y_pos, panel = graph_eternus_dx_temp(system_name, resource_name, metric, y_pos)
                 panels_list = panels_list + panel
            #case _:
            #    print("no option was found!!!")

    return y_pos, panels_list


def graph_eternus_dx_vol_read(system_name, resource_name, metric, y_pos):
    str_title = f"Read Performance ({resource_name})"
    panels_list = [RowPanel(title=str_title, gridPos=GridPos(h=1, w=24, x=0, y=y_pos))]
    line = y_pos + 1

    # Create Panel to show Read Latency
    panels_target_list = []
    for host in metric['hosts']:
        panels_target_list.append(
            InfluxDBTarget(
                query=f"SELECT mean(\"read_avg_time\") FROM \"eternus_dx_vol\" "
                      f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}') AND $timeFilter "
                      f"GROUP BY time($__interval), \"host\"::tag, \"vol_id\"::tag fill(null)",
                alias="$tag_host $tag_vol_id"
            )
        )

    panels_list.append(CollectorTimeSeries(
        title="Read Latency Avg",
        dataSource='default',
        targets=panels_target_list,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit="ms",
        gridPos=GridPos(h=7, w=8, x=0, y=line),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="bottom",
        legendDisplayMode="table",
        legendSortBy="Name",
        legendCalcs=['mean', 'max'],
        tooltipMode="multi",
        legendSortDesc=False,
    )
    )

    # Create Panel to show Read IO
    panels_target_list = []
    for host in metric['hosts']:
        panels_target_list.append(
            InfluxDBTarget(
                query=f"SELECT mean(\"read_iops\") FROM \"eternus_dx_vol\" "
                f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}') AND $timeFilter "
                f"GROUP BY time($__interval), \"host\"::tag, \"vol_id\"::tag fill(null)",
                alias="$tag_host $tag_vol_id"
            )
        )

    panels_list.append(CollectorTimeSeries(
        title="Read IOPS",
        dataSource='default',
        targets=panels_target_list,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit="iops",
        gridPos=GridPos(h=7, w=8, x=8, y=line),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="bottom",
        legendDisplayMode="table",
        legendSortBy="Name",
        legendCalcs=['mean', 'max'],
        tooltipMode="multi",
        legendSortDesc=False,
    )
    )

    # Create Panel to show Read Bandwidth
    panels_target_list = []
    for host in metric['hosts']:
        panels_target_list.append(
            InfluxDBTarget(
                query=f"SELECT mean(\"read_throughput\") FROM \"eternus_dx_vol\" "
                      f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}') AND $timeFilter "
                      f"GROUP BY time($__interval), \"host\"::tag, \"vol_id\"::tag fill(null)",
                alias="$tag_host $tag_vol_id"
            )
        )

    panels_list.append(CollectorTimeSeries(
        title="Read Bandwidth",
        dataSource='default',
        targets=panels_target_list,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit="MBs",
        gridPos=GridPos(h=7, w=8, x=16, y=line),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="bottom",
        legendDisplayMode="table",
        legendSortBy="Name",
        legendCalcs=['mean', 'max'],
        tooltipMode="multi",
        legendSortDesc=False,
    )
    )

    line = line + 7

    return line, panels_list


def graph_eternus_dx_vol_write(system_name, resource_name, metric, y_pos):
    str_title = f"Write Performance ({resource_name})"
    panels_list = [RowPanel(title=str_title, gridPos=GridPos(h=1, w=24, x=0, y=y_pos))]
    line = y_pos + 1

    # Create Panel to show Write Latency
    panels_target_list = []
    for host in metric['hosts']:
        panels_target_list.append(
            InfluxDBTarget(
                query=f"SELECT mean(\"write_avg_time\") FROM \"eternus_dx_vol\" "
                      f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}') AND $timeFilter " 
                      f"GROUP BY time($__interval), \"host\"::tag, \"vol_id\"::tag fill(null)",
                alias="$tag_host $tag_vol_id"
            )
        )

    panels_list.append(CollectorTimeSeries(
        title="Write Latency Avg",
        dataSource='default',
        targets=panels_target_list,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit="ms",
        gridPos=GridPos(h=7, w=8, x=0, y=line),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="bottom",
        legendDisplayMode="table",
        legendSortBy="Name",
        legendCalcs=['mean', 'max'],
        tooltipMode="multi",
        legendSortDesc=False,
    )
    )

    # Create Panel to show Write IO
    panels_target_list = []
    for host in metric['hosts']:
        panels_target_list.append(
            InfluxDBTarget(
                query=f"SELECT mean(\"write_iops\") FROM \"eternus_dx_vol\" "
                f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}') AND $timeFilter "
                f"GROUP BY time($__interval), \"host\"::tag, \"vol_id\"::tag fill(null)",
                alias="$tag_host $tag_vol_id"
            )
        )

    panels_list.append(CollectorTimeSeries(
        title="Write IOPS",
        dataSource='default',
        targets=panels_target_list,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit="iops",
        gridPos=GridPos(h=7, w=8, x=8, y=line),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="bottom",
        legendDisplayMode="table",
        legendSortBy="Name",
        legendCalcs=['mean', 'max'],
        tooltipMode="multi",
        legendSortDesc=False,
    )
    )

    # Create Panel to show Write Bandwidth
    panels_target_list = []
    for host in metric['hosts']:
        panels_target_list.append(
            InfluxDBTarget(
                query=f"SELECT mean(\"write_throughput\") FROM \"eternus_dx_vol\" "
                      f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}') AND $timeFilter "
                      f"GROUP BY time($__interval), \"host\"::tag, \"vol_id\"::tag fill(null)",
                alias="$tag_host $tag_vol_id"
            )
        )

    panels_list.append(CollectorTimeSeries(
        title="Write Bandwidth",
        dataSource='default',
        targets=panels_target_list,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit="MBs",
        gridPos=GridPos(h=7, w=8, x=16, y=line),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="bottom",
        legendDisplayMode="table",
        legendSortBy="Name",
        legendCalcs=['mean', 'max'],
        tooltipMode="multi",
        legendSortDesc=False,
    )
    )

    line = line + 7

    return line, panels_list


def graph_eternus_dx_power(system_name, resource_name, metric, y_pos):
    str_title = f"Power Consumption ({resource_name})"
    panels_list = [RowPanel(title=str_title, gridPos=GridPos(h=1, w=24, x=0, y=y_pos))]
    line = y_pos + 1

    # Create Panel to Power Consumption
    panels_target_list = []
    for host in metric['hosts']:
        panels_target_list.append(
            InfluxDBTarget(
                query=f"SELECT mean(\"power_watt\") FROM \"eternus_dx_power\" "
                      f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}') AND $timeFilter "
                      f"GROUP BY time($__interval), \"host\"::tag fill(null)",
                alias="$tag_host"
            )
        )

    panels_list.append(CollectorTimeSeries(
        title="Power Consumption",
        dataSource='default',
        targets=panels_target_list,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit="watt",
        gridPos=GridPos(h=7, w=12, x=0, y=line),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="bottom",
        legendDisplayMode="table",
        legendSortBy="Name",
        legendCalcs=['mean', 'max'],
        tooltipMode="multi",
        legendSortDesc=False,
    )
    )

    # Create Panel to show CO2 emissions
    panels_target_list = []
    for host in metric['hosts']:
        panels_target_list.append(
            InfluxDBTarget(
                query=f"SELECT 0.00085 * mean(\"power_watt\") FROM \"eternus_dx_power\" "
                      f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}') AND $timeFilter "
                      f"GROUP BY time($__interval), \"host\"::tag fill(null)",
                alias="$tag_host"
            )
        )

    panels_list.append(CollectorTimeSeries(
        title="CO2 Emissions",
        dataSource='default',
        targets=panels_target_list,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit="masskg",
        gridPos=GridPos(h=7, w=12, x=12, y=line),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="bottom",
        legendDisplayMode="table",
        legendSortBy="Name",
        legendCalcs=['mean', 'max'],
        tooltipMode="multi",
        legendSortDesc=False,
    )
    )

    line = line + 7

    return line, panels_list

def graph_eternus_dx_temp(system_name, resource_name, metric, y_pos):
    str_title = f"Intake Temperature ({resource_name})"
    panels_list = [RowPanel(title=str_title, gridPos=GridPos(h=1, w=24, x=0, y=y_pos))]
    line = y_pos + 1

    # Create Panel to Intake Temperature
    panels_target_list = []
    for host in metric['hosts']:
        panels_target_list.append(
            InfluxDBTarget(
                query=f"SELECT mean(\"intake_temp\") FROM \"eternus_dx_temp\" "
                      f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}') AND $timeFilter "
                      f"GROUP BY time($__interval), \"host\"::tag fill(null)",
                alias="$tag_host"
            )
        )

    panels_list.append(CollectorTimeSeries(
        title="Intake Temperature",
        dataSource='default',
        targets=panels_target_list,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit="celsius",
        gridPos=GridPos(h=7, w=24, x=0, y=line),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="bottom",
        legendDisplayMode="table",
        legendSortBy="Name",
        legendCalcs=['mean', 'max'],
        tooltipMode="multi",
        legendSortDesc=False,
    )
    )

    line = line + 7

    return line, panels_list


def graph_eternus_dx_dashboard_vars(data):
    tpl_lst = []

    for metric in data:
        match metric['metric']:
            case "tppool":
                tpl_lst = tpl_lst + [Template(
                    # dataSource="default",
                    name='tpp',
                    label='tpp',
                    query='SHOW TAG VALUES WITH KEY = \"tppool_nr\"',
                    type='query',
                    includeAll=True,
                    multi=True,
                    allValue=True,
                    default='All',
                    refresh=2,
                    hide=HIDE_VARIABLE,
                )
                ]

    return tpl_lst



def graph_eternus_dx_tpp(system_name, resource_name, metric, y_pos):

    # marteladão - tem de ser melhorado (está a forçar este painel a seguir ao cpu)
    y_pos = 4
    str_title = f"Capacity ({resource_name})"
    panels_list = [RowPanel(title=str_title, gridPos=GridPos(h=1, w=24, x=0, y=y_pos))]
    line = y_pos + 1

    #panels_target_list = []
    panels_target_physical_list = []
    panels_target_reduction_list = []
    panels_target_logical_list = []
    for host in metric['hosts']:
        #Target queries for Physical Space
        panels_target_physical_list.append(
                InfluxDBTarget(
                query=f"SELECT max(\"total_capacity\") FROM \"eternus_dx_tppool\" "
                f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}' AND \"tppool_nr\"::tag =~ /^$tpp$/) AND $timeFilter "
                f"GROUP BY time($__interval), \"host\"::tag, \"tppool_nr\"::tag fill(null)",
                alias="$tag_host TPP#$tag_tppool_nr Physical Capacity",
            ),
        )
        panels_target_physical_list.append(
                InfluxDBTarget(
                query=f"SELECT max(\"use_capacity\") FROM \"eternus_dx_tppool\" "
                f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}' AND \"tppool_nr\"::tag =~ /^$tpp$/) AND $timeFilter "
                f"GROUP BY time($__interval), \"host\"::tag, \"tppool_nr\"::tag fill(null)",
                alias="$tag_host TPP#$tag_tppool_nr Physical Used",
            ),
        )
        panels_target_physical_list.append(
                InfluxDBTarget(
                query=f"SELECT max(\"total_size_requested\") FROM \"eternus_dx_tppool\" "
                f"WHERE (\"system\"::tag = '{system_name}' AND \"host\"::tag = '{host}' AND \"tppool_nr\"::tag =~ /^$tpp$/) AND $timeFilter "
                f"GROUP BY time($__interval), \"host\"::tag, \"tppool_nr\"::tag fill(null)",
                alias="$tag_host TPP#$tag_tppool_nr Logical Requested",
            ),
        )


        # Panel for Logical Space
    panels_list.append(CollectorTimeSeries(
        title="Space Usage Physical per TPP",
        repeat=Repeat(direction='h', variable='tpp', maxPerRow=2),
        dataSource='default',
        targets=panels_target_physical_list,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit="decmbytes",
        gridPos=GridPos(h=7, w=8, x=0, y=line),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="bottom",
        legendDisplayMode="table",
        legendSortBy="Name",
        legendCalcs=['mean', 'max'],
        tooltipMode="multi",
        legendSortDesc=False,
    )
    )

    line = line + 7

    return line, panels_list



def create_main_observit_dashboard(data):
    panels = []
    templating = []
    y_pos = 3

    panels = [Text(
        title="observIT",
        gridPos=GridPos(h=3, w=24, x=0, y=0),
        mode="html",
        content="<h1>Capacity Management</h1>",
    )]

    #panels.append(RowPanel(title="Total Storage Capacity", gridPos=GridPos(h=1, w=24, x=0, y=y_pos)))

    logging.debug(f"Received host list for the creation of main dashboard : {data} ")

    for resource_type, systems in data.items():
        # Dynamically determine the function to call based on resource type
        #print(f"My data is {resource_type} / {systems} ")

        graph_function_name = f"graph_{resource_type}_overview"
        logging.debug(f" I Will calll{graph_function_name} ")   
        
        for system, hosts in systems.items():
            # logging.debug(f"Calling function {graph_function_name}_total({system})")
            # try:
            #     graph_function = globals().get(f"{graph_function_name}_total")
            #     if graph_function:
            #         y_pos, panel = graph_function(system, "Eternus Total", y_pos)
            #         panels = panels + panel
            #     else:
            #         raise ValueError(f"Function '{graph_function_name}' not found.")
            # except Exception as e:
            #     logging.debug(f"Error processing {system}, {host} for {resource_type}: {e}")
            for host in hosts:
                panels.append(RowPanel(title="Storage Capacity per host", gridPos=GridPos(h=1, w=24, x=0, y=y_pos)))
                logging.debug(f"Calling function {graph_function_name}({system},{host})")
                try:
                    graph_function = globals().get(graph_function_name)
                    if graph_function:
                        y_pos, panel = graph_function(system, host, y_pos)
                        panels = panels + panel
                    else:
                        raise ValueError(f"Function '{graph_function_name}' not found.")
                except Exception as e:
                    logging.debug(f"Error processing {system}, {host} for {resource_type}: {e}")

    my_dashboard = Dashboard(
        title="ObservIT Land Page",
        description="observIT auto generated dashboard",
        tags="observIT main",
        timezone="browser",
        refresh="1m",
        time= Time("now-12M", "now+3M"),
        panels=panels,
        templating=Templating(templating),
    ).auto_panel_ids()
 

    return my_dashboard 


def graph_eternus_dx_overview(system, host, y_pos):


    panels_list =[]
    pos = y_pos + 1


   #Define queries
   ############################################################################################################################################
 
   #Query for [storage name] Capacity 
    target_fs = [
        InfluxDBTarget(
            query=f"SELECT SUM(*) FROM (SELECT LAST(\"total_capacity\") FROM \"eternus_dx_tppool\" " 
                    f"WHERE (\"system\"::tag = '{system}' AND \"host\"::tag = '{host}') AND $timeFilter "
                    f"GROUP BY time($__interval), \"tppool_nr\"::tag fill(null)) WHERE $timeFilter GROUP BY time($__interval)",
            alias="Total"
        ),
        InfluxDBTarget(
            query=f"SELECT SUM(*) FROM (SELECT LAST(\"use_capacity\") FROM \"eternus_dx_tppool\" "
                    f"WHERE (\"system\"::tag = '{system}' AND \"host\"::tag = '{host}') AND $timeFilter "
                    f"GROUP BY time($__interval), \"tppool_nr\"::tag fill(null)) WHERE $timeFilter GROUP BY time($__interval)",
            alias="Used"
        ),
        InfluxDBTarget(
            query=f"SELECT HOLT_WINTERS(SUM(*), 90, 0) FROM (SELECT LAST(\"use_capacity\") FROM \"eternus_dx_tppool\" "
                    f"WHERE (\"system\"::tag = '{system}' AND \"host\"::tag = '{host}') AND $timeFilter "
                    f"GROUP BY time($__interval), \"tppool_nr\"::tag fill(null)) WHERE $timeFilter GROUP BY time($__interval)",
            alias="Forecast"
        ),
    ]  

    target_fs.append(
        {
            "refId": "D",
            "datasource": {
                "type": "__expr__",
                "uid": "__expr__",
                "name": "Expression"
            },
            "type": "math",
            "hide": False,
            "expression": "$A*0.8"
         }
      )


    json_overrides_for_capacity = [
        {
            "matcher": {
                "id": "byName",
                "options": "Total"
            },
            "properties": [
                {
                    "id": "custom.fillBelowTo",
                    "value": "Used"
                },
                {
                    "id": "color",
                    "value": {
                        "fixedColor": "super-light-blue",
                        "mode": "fixed"
                    }
                },
                {
                    "id": "custom.lineWidth",
                    "value": 2
                }
            ]
        },
        {
            "matcher": {
                "id": "byName",
                "options": "Forecast"
            },
            "properties": [
                {
                    "id": "color",
                    "value": {
                        "fixedColor": "super-light-purple",
                        "mode": "fixed"
                    }
                }
            ]
        },
        {
            "matcher": {
                "id": "byName",
                "options": "Used"
            },
            "properties": [
                {
                    "id": "color",
                    "value": {
                        "mode": "fixed",
                        "fixedColor": "blue"
                    }
                }
            ]
        },
        {
        "matcher": {
          "id": "byName",
          "options": "D"
        },
        "properties": [
          {
            "id": "custom.lineWidth",
            "value": 5
          },
          {
            "id": "custom.lineStyle",
            "value": {
              "dash": [
                10,
                10
              ],
              "fill": "dash"
            }
          },
          {
            "id": "color",
            "value": {
              "fixedColor": "red",
              "mode": "fixed"
            }
          },
          {
            "id": "custom.fillOpacity",
            "value": 0
          },
          {
            "id": "displayName",
            "value": "80%"
          }
        ]
      }
    ]

    panels_list.append(CollectorTimeSeries(
        title=f"{host} Capacity",
        dataSource='default',
        targets=target_fs,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit="decmbytes",
        gridPos=GridPos(h=14, w=9, x=0, y=pos),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="bottom",
        legendDisplayMode="table",
        legendCalcs=['mean', 'min', 'max'],
        tooltipMode="multi",
        overrides=json_overrides_for_capacity,
        valueMin=0,
    ))

    ############################################################################################################################################
    #Query for [storage name] CPU utilization (%) 
    target = [
        InfluxDBTarget(
            query=f"SELECT mean(\"busyrate\") FROM \"eternus_dx_cpu\" "
                f"WHERE (\"system\"::tag = '{system}' AND \"host\"::tag = '{host}') AND $timeFilter "
                f"GROUP BY time($__interval), \"CM\"::tag fill(null)",
            alias="CM#$tag_CM"
        ),
    ]

    panels_list.append(CollectorTimeSeries(
        title=f"{host} CPU Utilization (%)",
        dataSource='default',
        targets=target,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit="percent",
        gridPos=GridPos(h=7, w=4, x=9, y=y_pos),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="bottom",
        legendDisplayMode="table",
        legendSortBy="Name",
        legendCalcs=['mean', 'max'],
        legendSortDesc=False,
        tooltipMode="multi",
        valueMax=100,
        )
    )


    ############################################################################################################################################
    #Query: [storage name] IOPS R+W Avg $__interval


    target = [
        InfluxDBTarget(
            query=f"SELECT mean(\"read_iops\")+mean(\"write_iops\") FROM \"eternus_dx_vol\" "
                f"WHERE (\"system\"::tag = '{system}' AND \"host\"::tag = '{host}') AND $timeFilter "
                f"GROUP BY time($__interval) fill(null)",
            alias="Total IOPS"
        ),
    ]


    panels_list.append(CollectorTimeSeries(
            title=f"{host} Total IOPS",
            dataSource='default',
            targets=target,
            drawStyle='line',
            lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
            showPoints=COLLECTOR_SHOW_POINTS,
            gradientMode=COLLECTOR_GRADIENT_MODE,
            fillOpacity=COLLECTOR_FILL_OPACITY,
            unit="iops",
            gridPos=GridPos(h=7, w=4, x=9, y=y_pos+7),
            spanNulls=COLLECTOR_SPAN_NULLS,
            legendPlacement="bottom",
            legendDisplayMode="table",
            legendSortBy="Name",
            legendCalcs=['mean', 'max'],
            tooltipMode="multi",
            legendSortDesc=False,
        )
        )

    ############################################################################################################################################
    #Query: [storage name] IOPS R+W Avg $__interval

    target = [
        InfluxDBTarget(
            query=f"SELECT mean(\"read_avg_time\")+mean(\"write_avg_time\") FROM \"eternus_dx_vol\" "
                    f"WHERE (\"system\"::tag = '{system}' AND \"host\"::tag = '{host}') AND $timeFilter "
                    f"GROUP BY time($__interval) fill(null)",
            alias="Total Latency"
        ),
        # InfluxDBTarget(
        #     query=f"SELECT mean(\"write_avg_time\") FROM \"eternus_dx_vol\" "
        #             f"WHERE (\"system\"::tag = '{system}' AND \"host\"::tag = '{host}') AND $timeFilter "
        #             f"GROUP BY time($__interval) fill(null)",
        #     alias="Write Average"
        # ),
    ]

    panels_list.append(CollectorTimeSeries(
        title=f"{host} Total Latency",
        dataSource='default',
        targets=target,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit="ms",
        gridPos=GridPos(h=7, w=4, x=13, y=y_pos),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="bottom",
        legendDisplayMode="table",
        legendSortBy="Name",
        legendCalcs=['mean', 'max'],
        tooltipMode="multi",
        legendSortDesc=False,
    )
    )

    ############################################################################################################################################
    #Query: [storage name] Total Throughput R+W Avg $__interval

    target = [
            InfluxDBTarget(
                query=f"SELECT mean(\"read_throughput\")+mean(\"write_throughput\") FROM \"eternus_dx_vol\" "
                        f"WHERE (\"system\"::tag = '{system}' AND \"host\"::tag ='{host}' ) AND $timeFilter "
                        f"GROUP BY time($__interval) fill(null)",
                   alias="Total Throughput"
            ),
            # InfluxDBTarget(
            #     query=f"SELECT mean(\"write_throughput\") FROM \"eternus_dx_vol\" "
            #             f"WHERE (\"system\"::tag = '{system}' AND \"host\"::tag ='{host}' ) AND $timeFilter "
            #             f"GROUP BY time($__interval) fill(null)",
            #     alias="Write Average"
            #),
        ]



    panels_list.append(CollectorTimeSeries(
            title=f"{host} Total Bandwidth",
            dataSource='default',
            targets=target,
            drawStyle='line',
            lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
            showPoints=COLLECTOR_SHOW_POINTS,
            gradientMode=COLLECTOR_GRADIENT_MODE,
            fillOpacity=COLLECTOR_FILL_OPACITY,
            unit="MBs",
            gridPos=GridPos(h=7, w=4, x=13, y=y_pos+7),
            spanNulls=COLLECTOR_SPAN_NULLS,
            legendPlacement="bottom",
            legendDisplayMode="table",
            legendSortBy="Name",
            legendCalcs=['mean', 'max'],
            tooltipMode="multi",
            legendSortDesc=False,
        )
        )


    ############################################################################################################################################
     # Query for: StorageIO - Volumes with less than 10000 I/O's during the 2 Months
    target = [
        InfluxDBTarget(
            query=f"SELECT sum(\"read_iops\") + sum(\"write_iops\") AS \"Total I/Os\", max(\"vol_size\") as \"Volume Capacity\" FROM \"eternus_dx_vol\" "
                    f"WHERE (\"system\"::tag = '{system}' AND \"host\"::tag = '{host}') AND $timeFilter "
                    f"GROUP BY \"host\"::tag, \"vol_id\"::tag fill(none)",
            format="table"
        )
    ]


    json_overrides_table = [
        {
            "matcher": {
            "id": "byName",
            "options": "Volume Capacity"
            },
            "properties": [
            {
                "id": "unit",
                "value": "mbytes"
            }
            ]
        },
        {
            "matcher": {
            "id": "byName",
            "options": "vol_id"
            },
            "properties": [
            {
                "id": "unit"
            },
            {
                "id": "custom.width",
                "value": 107
            }
            ]
        },
        {
            "matcher": {
            "id": "byName",
            "options": "Time"
            },
            "properties": [
            {
                "id": "custom.hidden",
                "value": True
            }
            ]
        }
        ]

    transformation = [
    {
      "id": "filterByValue",
      "options": {
        "filters": [
          {
            "config": {
              "id": "lower",
              "options": {
                "value": 10000
              }
            },
            "fieldName": "Total I/Os"
          }
        ],
        "match": "all",
        "type": "include"
      }
    }
  ]


    table_field_sort = [TableSortByField(displayName='Total I/O', desc=True)]

    panels_list.append(CollectorTable(
        title=f"{host} StorageIO - Volumes <10K iops during the ",
        dataSource='default',
        targets=target,
        gridPos=GridPos(h=14, w=7, x=17, y=y_pos),
        filterable=True,
        unit="iops",
        displayMode="color-text",
        colorMode="thresholds",
        transformations=transformation,
        timeFrom="2M",
        overrides=json_overrides_table,
        sortBy=table_field_sort,
        )
    )

    pos = pos + 14
    
    return pos, panels_list



def graph_eternus_dx_total_overview(system, description, y_pos):


    panels_list =[]
    pos = y_pos + 1


   #Define queries
   ############################################################################################################################################
 
   #Query for [storage name] Capacity 
    target_fs = [
        InfluxDBTarget(
            query=f"SELECT SUM(*) FROM (SELECT LAST(\"total_capacity\") FROM \"eternus_dx_tppool\" " 
                    f"WHERE (\"system\"::tag = '{system}') AND $timeFilter "
                    f"GROUP BY time($__interval), \"tppool_nr\"::tag fill(null)) WHERE $timeFilter GROUP BY time($__interval)",
            alias="Total"
        ),
        InfluxDBTarget(
            query=f"SELECT SUM(*) FROM (SELECT LAST(\"use_capacity\") FROM \"eternus_dx_tppool\" "
                    f"WHERE (\"system\"::tag = '{system}') AND $timeFilter "
                    f"GROUP BY time($__interval), \"tppool_nr\"::tag fill(null)) WHERE $timeFilter GROUP BY time($__interval)",
            alias="Used"
        ),
        InfluxDBTarget(
            query=f"SELECT HOLT_WINTERS(SUM(*), 90, 0) FROM (SELECT LAST(\"use_capacity\") FROM \"eternus_dx_tppool\" "
                    f"WHERE (\"system\"::tag = '{system}') AND $timeFilter "
                    f"GROUP BY time($__interval), \"tppool_nr\"::tag fill(null)) WHERE $timeFilter GROUP BY time($__interval)",
            alias="Forecast"
        ),
    ]  

    target_fs.append(
        {
            "refId": "D",
            "datasource": {
                "type": "__expr__",
                "uid": "__expr__",
                "name": "Expression"
            },
            "type": "math",
            "hide": False,
            "expression": "$A*0.8"
         }
      )


    json_overrides_for_capacity = [
        {
            "matcher": {
                "id": "byName",
                "options": "Total"
            },
            "properties": [
                {
                    "id": "custom.fillBelowTo",
                    "value": "Used"
                },
                {
                    "id": "color",
                    "value": {
                        "fixedColor": "super-light-blue",
                        "mode": "fixed"
                    }
                },
                {
                    "id": "custom.lineWidth",
                    "value": 2
                }
            ]
        },
        {
            "matcher": {
                "id": "byName",
                "options": "Forecast"
            },
            "properties": [
                {
                    "id": "color",
                    "value": {
                        "fixedColor": "super-light-purple",
                        "mode": "fixed"
                    }
                }
            ]
        },
        {
            "matcher": {
                "id": "byName",
                "options": "Used"
            },
            "properties": [
                {
                    "id": "color",
                    "value": {
                        "mode": "fixed",
                        "fixedColor": "blue"
                    }
                }
            ]
        },
        {
        "matcher": {
          "id": "byName",
          "options": "D"
        },
        "properties": [
          {
            "id": "custom.lineWidth",
            "value": 5
          },
          {
            "id": "custom.lineStyle",
            "value": {
              "dash": [
                10,
                10
              ],
              "fill": "dash"
            }
          },
          {
            "id": "color",
            "value": {
              "fixedColor": "red",
              "mode": "fixed"
            }
          },
          {
            "id": "custom.fillOpacity",
            "value": 0
          },
          {
            "id": "displayName",
            "value": "80%"
          }
        ]
      }
    ]

    panels_list.append(CollectorTimeSeries(
        title=f"{description} Capacity",
        dataSource='default',
        targets=target_fs,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit=COLLECTOR_FS_UNITS,
        gridPos=GridPos(h=14, w=9, x=0, y=pos),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="bottom",
        legendDisplayMode="table",
        legendCalcs=['mean', 'min', 'max'],
        tooltipMode="multi",
        overrides=json_overrides_for_capacity,
        valueMin=0,
    ))

    ############################################################################################################################################
    #Query for [storage name] CPU utilization (%) 
    target = [
        InfluxDBTarget(
            query=f"SELECT mean(\"busyrate\") FROM \"eternus_dx_cpu\" "
                f"WHERE (\"system\"::tag = '{system}') AND $timeFilter "
                f"GROUP BY time($__interval), \"CM\"::tag fill(null)",
            alias="CM#$tag_CM"
        ),
    ]

    panels_list.append(CollectorTimeSeries(
        title=f"{description} CPU Utilization (%)",
        dataSource='default',
        targets=target,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit="percent",
        gridPos=GridPos(h=7, w=4, x=9, y=y_pos),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="bottom",
        legendDisplayMode="table",
        legendSortBy="Name",
        legendCalcs=['mean', 'max'],
        legendSortDesc=False,
        tooltipMode="multi",
        valueMax=100,
        )
    )


    ############################################################################################################################################
    #Query: [storage name] IOPS R+W Avg $__interval


    target = [
        InfluxDBTarget(
            query=f"SELECT mean(\"read_avg_time\")+mean(\"write_avg_time\") FROM \"eternus_dx_vol\" "
                f"WHERE (\"system\"::tag = '{system}') AND $timeFilter "
                f"GROUP BY time($__interval) fill(null)",
            alias="Total IOPS"
        ),
        # InfluxDBTarget(
        #     query=f"SELECT mean(\"write_avg_time\") FROM \"eternus_dx_vol\" "
        #         f"WHERE (\"system\"::tag = '{system}' AND \"host\"::tag = '{host}') AND $timeFilter "
        #         f"GROUP BY time($__interval) fill(null)",
        #     alias="Write IOPS Average"
        # ),
    ]


    panels_list.append(CollectorTimeSeries(
            title=f"{description} Total IOPS",
            dataSource='default',
            targets=target,
            drawStyle='line',
            lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
            showPoints=COLLECTOR_SHOW_POINTS,
            gradientMode=COLLECTOR_GRADIENT_MODE,
            fillOpacity=COLLECTOR_FILL_OPACITY,
            unit="iops",
            gridPos=GridPos(h=7, w=4, x=9, y=y_pos+7),
            spanNulls=COLLECTOR_SPAN_NULLS,
            legendPlacement="bottom",
            legendDisplayMode="table",
            legendSortBy="Name",
            legendCalcs=['mean', 'max'],
            tooltipMode="multi",
            legendSortDesc=False,
        )
        )

    ############################################################################################################################################
    #Query: [storage name] IOPS R+W Avg $__interval

    target = [
        InfluxDBTarget(
            query=f"SELECT mean(\"read_avg_time\")+mean(\"write_avg_time\") FROM \"eternus_dx_vol\" "
                    f"WHERE (\"system\"::tag = '{system}') AND $timeFilter "
                    f"GROUP BY time($__interval) fill(null)",
            alias="Total Latency"
        ),
        # InfluxDBTarget(
        #     query=f"SELECT mean(\"write_avg_time\") FROM \"eternus_dx_vol\" "
        #             f"WHERE (\"system\"::tag = '{system}' AND \"host\"::tag = '{host}') AND $timeFilter "
        #             f"GROUP BY time($__interval) fill(null)",
        #     alias="Write Average"
        # ),
    ]

    panels_list.append(CollectorTimeSeries(
        title=f"{description} Total Latency",
        dataSource='default',
        targets=target,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit="ms",
        gridPos=GridPos(h=7, w=4, x=13, y=y_pos),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="bottom",
        legendDisplayMode="table",
        legendSortBy="Name",
        legendCalcs=['mean', 'max'],
        tooltipMode="multi",
        legendSortDesc=False,
    )
    )

    ############################################################################################################################################
    #Query: [storage name] Total Throughput R+W Avg $__interval

    target = [
            InfluxDBTarget(
                query=f"SELECT mean(\"read_throughput\")+mean(\"write_throughput\") FROM \"eternus_dx_vol\" "
                        f"WHERE (\"system\"::tag = '{system}') AND $timeFilter "
                        f"GROUP BY time($__interval) fill(null)",
                   alias="Total Throughput"
            ),
            # InfluxDBTarget(
            #     query=f"SELECT mean(\"write_throughput\") FROM \"eternus_dx_vol\" "
            #             f"WHERE (\"system\"::tag = '{system}' AND \"host\"::tag ='{host}' ) AND $timeFilter "
            #             f"GROUP BY time($__interval) fill(null)",
            #     alias="Write Average"
            #),
        ]



    panels_list.append(CollectorTimeSeries(
            title=f"{description} Total Bandwidth",
            dataSource='default',
            targets=target,
            drawStyle='line',
            lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
            showPoints=COLLECTOR_SHOW_POINTS,
            gradientMode=COLLECTOR_GRADIENT_MODE,
            fillOpacity=COLLECTOR_FILL_OPACITY,
            unit="MBs",
            gridPos=GridPos(h=7, w=4, x=13, y=y_pos+7),
            spanNulls=COLLECTOR_SPAN_NULLS,
            legendPlacement="bottom",
            legendDisplayMode="table",
            legendSortBy="Name",
            legendCalcs=['mean', 'max'],
            tooltipMode="multi",
            legendSortDesc=False,
        )
        )


    ############################################################################################################################################
     # Query for: StorageIO - Volumes with less than 10000 I/O's during the 2 Months
    target = [
        InfluxDBTarget(
            query=f"SELECT sum(\"read_iops\") + sum(\"write_iops\") AS \"Total I/Os\", max(\"vol_size\") as \"Volume Capacity\" FROM \"eternus_dx_vol\" "
                    f"WHERE (\"system\"::tag = '{system}') AND $timeFilter "
                    f"GROUP BY \"host\"::tag, \"vol_id\"::tag fill(none)",
            format="table"
        )
    ]


    json_overrides_table = [
        {
            "matcher": {
            "id": "byName",
            "options": "Volume Capacity"
            },
            "properties": [
            {
                "id": "unit",
                "value": "mbytes"
            }
            ]
        },
        {
            "matcher": {
            "id": "byName",
            "options": "vol_id"
            },
            "properties": [
            {
                "id": "unit"
            },
            {
                "id": "custom.width",
                "value": 107
            }
            ]
        },
        {
            "matcher": {
            "id": "byName",
            "options": "Time"
            },
            "properties": [
            {
                "id": "custom.hidden",
                "value": True
            }
            ]
        }
        ]

    transformation = [
    {
      "id": "filterByValue",
      "options": {
        "filters": [
          {
            "config": {
              "id": "lower",
              "options": {
                "value": 10000
              }
            },
            "fieldName": "Total I/Os"
          }
        ],
        "match": "all",
        "type": "include"
      }
    }
  ]


    table_field_sort = [TableSortByField(displayName='Total I/O', desc=True)]

    panels_list.append(CollectorTable(
        title=f"{description} StorageIO - Volumes <10K iops during the ",
        dataSource='default',
        targets=target,
        gridPos=GridPos(h=14, w=7, x=17, y=y_pos),
        filterable=True,
        unit="iops",
        displayMode="color-text",
        colorMode="thresholds",
        transformations=transformation,
        timeFrom="2M",
        overrides=json_overrides_table,
        sortBy=table_field_sort,
        )
    )

    pos = pos + 14
    
    return pos, panels_list



def graph_powerstore_overview(system, host, y_pos):


    panels_list =[]
    pos = y_pos + 1


   #Define queries
   ############################################################################################################################################
 
   #Query for [storage name] Capacity 
    target_fs = [
        InfluxDBTarget(
            query=f"SELECT MAX(\"physical_total\") FROM \"powerstore_space\" "
                    f"WHERE (\"system\"::tag = '{system}'  AND \"host\"::tag = '{host}' ) AND $timeFilter "
                    f"GROUP BY time($__interval) fill(null)",
            alias="Total"
        ),
        InfluxDBTarget(
            query=f"SELECT MAX(\"physical_used\") FROM \"powerstore_space\" "
                    f"WHERE (\"system\"::tag = '{system}'  AND \"host\"::tag = '{host}' ) AND $timeFilter "
                    f"GROUP BY time($__interval) fill(null)",
            alias="Used"
        ),
        InfluxDBTarget(
            query=f"SELECT HOLT_WINTERS(MAX(\"physical_used\"), 90, 0) FROM \"powerstore_space\" "
                    f"WHERE (\"system\"::tag = '{system}'  AND \"host\"::tag = '{host}' ) AND $timeFilter "
                    f"GROUP BY time($__interval) fill(null)",
            alias="Forecast"
        ),
    ]  

    target_fs.append(
        {
            "refId": "D",
            "datasource": {
                "type": "__expr__",
                "uid": "__expr__",
                "name": "Expression"
            },
            "type": "math",
            "hide": False,
            "expression": "$A*0.8"
         }
      )


    json_overrides_for_capacity = [
        {
            "matcher": {
                "id": "byName",
                "options": "Total"
            },
            "properties": [
                {
                    "id": "custom.fillBelowTo",
                    "value": "Used"
                },
                {
                    "id": "color",
                    "value": {
                        "fixedColor": "super-light-blue",
                        "mode": "fixed"
                    }
                },
                {
                    "id": "custom.lineWidth",
                    "value": 2
                }
            ]
        },
        {
            "matcher": {
                "id": "byName",
                "options": "Forecast"
            },
            "properties": [
                {
                    "id": "color",
                    "value": {
                        "fixedColor": "super-light-purple",
                        "mode": "fixed"
                    }
                }
            ]
        },
        {
            "matcher": {
                "id": "byName",
                "options": "Used"
            },
            "properties": [
                {
                    "id": "color",
                    "value": {
                        "mode": "fixed",
                        "fixedColor": "blue"
                    }
                }
            ]
        },
        {
        "matcher": {
          "id": "byName",
          "options": "D"
        },
        "properties": [
          {
            "id": "custom.lineWidth",
            "value": 5
          },
          {
            "id": "custom.lineStyle",
            "value": {
              "dash": [
                10,
                10
              ],
              "fill": "dash"
            }
          },
          {
            "id": "color",
            "value": {
              "fixedColor": "red",
              "mode": "fixed"
            }
          },
          {
            "id": "custom.fillOpacity",
            "value": 0
          },
          {
            "id": "displayName",
            "value": "80%"
          }
        ]
      }
    ]

    panels_list.append(CollectorTimeSeries(
        title=f"{host} Capacity",
        dataSource='default',
        targets=target_fs,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit="bytes",
        gridPos=GridPos(h=14, w=9, x=0, y=pos),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="bottom",
        legendDisplayMode="table",
        legendCalcs=['mean', 'min', 'max'],
        tooltipMode="multi",
        overrides=json_overrides_for_capacity,
        valueMin=0,
    ))

    ############################################################################################################################################
    #Query for [storage name] CPU utilization (%) 
    target = [
        InfluxDBTarget(
            query=f"SELECT 100 * mean(\"io_workload_cpu_utilization\") FROM \"powerstore_node\" "
                    f"WHERE (\"system\"::tag = '{system}'  AND \"host\"::tag = '{host}' ) AND $timeFilter "
                    f"GROUP BY time($__interval), \"host\"::tag, \"node_id\"::tag fill(null)",
            alias="$tag_node_id"
        ),
    ]

    panels_list.append(CollectorTimeSeries(
        title=f"{host} CPU utilization (%)",
        dataSource='default',
        targets=target,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit="percent",
        gridPos=GridPos(h=7, w=4, x=9, y=y_pos),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="bottom",
        legendDisplayMode="table",
        legendSortBy="Name",
        legendCalcs=['mean', 'max'],
        legendSortDesc=False,
        tooltipMode="multi",
        valueMax=100,
        )
    )


    ############################################################################################################################################
    #Query: [storage name] IOPS R+W Avg $__interval


    target = [
        InfluxDBTarget(
            query=f"SELECT mean(\"total_iops\") FROM \"powerstore_node\" "
                f"WHERE (\"system\"::tag = 'powerstore1' AND \"host\"::tag = 'PASGPST001') AND $timeFilter "
                f"GROUP BY time($__interval) fill(null)",
            alias="Total IOPS"
        ),
        # InfluxDBTarget(
        #     query=f"SELECT mean(\"write_avg_time\") FROM \"eternus_dx_vol\" "
        #         f"WHERE (\"system\"::tag = '{system}' AND \"host\"::tag = '{host}') AND $timeFilter "
        #         f"GROUP BY time($__interval) fill(null)",
        #     alias="Write IOPS Average"
        # ),
    ]


    panels_list.append(CollectorTimeSeries(
            title=f"{host} IOPS Average",
            dataSource='default',
            targets=target,
            drawStyle='line',
            lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
            showPoints=COLLECTOR_SHOW_POINTS,
            gradientMode=COLLECTOR_GRADIENT_MODE,
            fillOpacity=COLLECTOR_FILL_OPACITY,
            unit="iops",
            gridPos=GridPos(h=7, w=4, x=9, y=y_pos+7),
            spanNulls=COLLECTOR_SPAN_NULLS,
            legendPlacement="bottom",
            legendDisplayMode="table",
            legendSortBy="Name",
            legendCalcs=['mean', 'max'],
            tooltipMode="multi",
            legendSortDesc=False,
        )
        )

    ############################################################################################################################################
    #Query: [storage name] IOPS R+W Avg $__interval

    target = [
        InfluxDBTarget(
            query=f"SELECT mean(\"avg_latency\") FROM \"powerstore_node\" "
                    f"WHERE (\"system\"::tag = '{system}' AND \"host\"::tag = '{host}') AND $timeFilter "
                    f"GROUP BY time($__interval) fill(null)",
            alias="Total Latency"
        ),
        # InfluxDBTarget(
        #     query=f"SELECT mean(\"write_avg_time\") FROM \"eternus_dx_vol\" "
        #             f"WHERE (\"system\"::tag = '{system}' AND \"host\"::tag = '{host}') AND $timeFilter "
        #             f"GROUP BY time($__interval) fill(null)",
        #     alias="Write Average"
        # ),
    ]

    panels_list.append(CollectorTimeSeries(
        title=f"{host} Latency Avg",
        dataSource='default',
        targets=target,
        drawStyle='line',
        lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
        showPoints=COLLECTOR_SHOW_POINTS,
        gradientMode=COLLECTOR_GRADIENT_MODE,
        fillOpacity=COLLECTOR_FILL_OPACITY,
        unit="µs",
        gridPos=GridPos(h=7, w=4, x=13, y=y_pos),
        spanNulls=COLLECTOR_SPAN_NULLS,
        legendPlacement="bottom",
        legendDisplayMode="table",
        legendSortBy="Name",
        legendCalcs=['mean', 'max'],
        tooltipMode="multi",
        legendSortDesc=False,
    )
    )

    ############################################################################################################################################
    #Query: [storage name] Total Throughput R+W Avg $__interval

    target = [
            InfluxDBTarget(
                query=f"SELECT mean(\"total_bandwidth\") FROM \"powerstore_node\" "
                        f"WHERE (\"system\"::tag = '{system}' AND \"host\"::tag ='{host}' ) AND $timeFilter "
                        f"GROUP BY time($__interval), \"host\"::tag, \"node_id\"::tag fill(null)",
                   alias="Total Throughput"
            ),
            # InfluxDBTarget(
            #     query=f"SELECT mean(\"write_throughput\") FROM \"eternus_dx_vol\" "
            #             f"WHERE (\"system\"::tag = '{system}' AND \"host\"::tag ='{host}' ) AND $timeFilter "
            #             f"GROUP BY time($__interval) fill(null)",
            #     alias="Write Average"
            # ),
        ]



    panels_list.append(CollectorTimeSeries(
            title=f"{host} Total Bandwidth",
            dataSource='default',
            targets=target,
            drawStyle='line',
            lineInterpolation=COLLECTOR_LINE_INTERPOLATION,
            showPoints=COLLECTOR_SHOW_POINTS,
            gradientMode=COLLECTOR_GRADIENT_MODE,
            fillOpacity=COLLECTOR_FILL_OPACITY,
            unit="binBps",
            gridPos=GridPos(h=7, w=4, x=13, y=y_pos+7),
            spanNulls=COLLECTOR_SPAN_NULLS,
            legendPlacement="bottom",
            legendDisplayMode="table",
            legendSortBy="Name",
            legendCalcs=['mean', 'max'],
            tooltipMode="multi",
            legendSortDesc=False,
        )
        )


    ############################################################################################################################################
     # Query for: StorageIO - Volumes with less than 10000 I/O's during the 2 Months
    target = [
        InfluxDBTarget(
            query=f"SELECT sum(\"read_iops\") + sum(\"write_iops\") AS \"Total I/Os\", max(\"vol_size\") as \"Volume Capacity\" FROM \"eternus_dx_vol\" "
                    f"WHERE (\"system\"::tag = '{system}' AND \"host\"::tag = '{host}') AND $timeFilter "
                    f"GROUP BY \"host\"::tag, \"vol_id\"::tag fill(none)",
            format="table"
        )
    ]


    json_overrides_table = [
        {
            "matcher": {
            "id": "byName",
            "options": "Volume Capacity"
            },
            "properties": [
            {
                "id": "unit",
                "value": "mbytes"
            }
            ]
        },
        {
            "matcher": {
            "id": "byName",
            "options": "vol_id"
            },
            "properties": [
            {
                "id": "unit"
            },
            {
                "id": "custom.width",
                "value": 107
            }
            ]
        },
        {
            "matcher": {
            "id": "byName",
            "options": "Time"
            },
            "properties": [
            {
                "id": "custom.hidden",
                "value": True
            }
            ]
        }
        ]

    transformation = [
    {
      "id": "filterByValue",
      "options": {
        "filters": [
          {
            "config": {
              "id": "lower",
              "options": {
                "value": 10000
              }
            },
            "fieldName": "Total I/Os"
          }
        ],
        "match": "all",
        "type": "include"
      }
    }
  ]


    table_field_sort = [TableSortByField(displayName='Total I/O', desc=True)]

    panels_list.append(CollectorTable(
        title=f"{host} StorageIO - Volumes <10K iops during the ",
        dataSource='default',
        targets=target,
        gridPos=GridPos(h=14, w=7, x=17, y=y_pos),
        filterable=True,
        unit="iops",
        displayMode="color-text",
        colorMode="thresholds",
        transformations=transformation,
        timeFrom="2M",
        overrides=json_overrides_table,
        sortBy=table_field_sort,
        )
    )

    pos = pos + 14
    
    return pos, panels_list

